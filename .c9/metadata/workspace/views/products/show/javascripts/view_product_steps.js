{"changed":true,"filter":false,"title":"view_product_steps.js","tooltip":"/views/products/show/javascripts/view_product_steps.js","value":"// STEP VIEW\n////////////////////////////////////////////////////////////////////////////// \nvar StepView = Backbone.View.extend({ \n  el: '.right_column',\n  initialize: function() {\n    var guests = thisProduct.get(\"guests\");\n    this.changed_names = false;\n    this.weights_reference = {2: \"200\", 3: \"300\" } // number refers to position of element in HTML hierarchy\n    this.listenTo(guests, 'change', this._renderQuickGuests)\n    this.listenTo(guests, 'destroy', this._renderQuickGuests)\n    this.listenTo(guests, 'add', this._renderQuickGuests)\n    this.listenTo(guests, 'addMultiple', this._renderQuickGuests)\n    this.listenTo(thisProduct, 'change:weight', this.renderWeight);\n    this.listenTo(thisProduct, \"change:total\", this.renderQtyAndPrice)\n    this.current_step = 1;\n  },\n  events: {     \n    \"click .buy\": \"checkout\",        \n    \"mouseenter .spc\": \"hoverOver\",\n    \"mouseleave .spc\": \"hoverOut\",     \n    \"click .texture\": \"updateTexture\", \n    \"click .weight\": \"updateWeight\",\n    \"focus #quick_guests\": \"selectQuickGuests\",    \n    \"blur #quick_guests\": \"hideQuickGuests\",\n    \"click #quick_guests\": \"updateCaretAfterClick\",\n    \"keyup #quick_guests\": \"newKeyPressGuests\",\n    \"paste #quick_guests\": \"newKeyPressGuests\"\n  },\n  // When the guests entry textarea is selected we add a class to the root element to enable us to detect that it \n  // has been focused and therefore make adjustments to the layout for mobile devices that do not have enough \n  // screen space when the onscreen keyboard appears\n  selectQuickGuests: function() { \n    $('body').addClass(\"quick_guests_selected\");\n    if(casamiento_test_for_mobile) $('html,body').scrollTop($(\"#quick_guests\").offset().top)\n//    this.$('#quick_guests').focus();\n  },\n  hideQuickGuests: function() { $('body').removeClass(\"quick_guests_selected\"); },\n  // If you happen to click somewhere else on the textarea in the split second before rendering, this stops the caret from jumping to the previous location\n  updateCaretAfterClick: function() { this.caret_position = this.$('#quick_guests')[0].selectionStart; },\n  \n  updateWeight: function(e) {   \n    var weight_selected = $(e.currentTarget).index();\n    weight_selected = this.weights_reference[weight_selected];\n    thisProduct.set(\"weight\", weight_selected);\n  },\n  renderWeight: function(e) {\n    this.$('.weight').removeClass('selected').addClass('deselected');\n    this.$('#weight_' + thisProduct.get(\"weight\")).addClass(\"selected\").removeClass('deselected')      \n  },\n  _renderQuickGuests: function() { \n    console.log(this.updated_from_textarea)\n    if(!this.updated_from_textarea) {\n      console.log(thisProduct.get(\"guests\").pluck(\"name\")); \n      this.$('#quick_guests').val(thisProduct.get(\"guests\").pluck(\"name\").join(\"\\n\")) \n    }\n    this.updated_from_textarea = false;\n    },\n  _renderCaret: function() {\n    if(this.caret_position) {        \n    setSelectionRange($('#quick_guests')[0], this.caret_position, this.caret_position);\n    this.caret_position = undefined\n   }  \n  },\n  newKeyPressGuests: _.debounce(function() {\n    this.updated_from_textarea = true;\n    this.caret_position = this.$('#quick_guests')[0].selectionStart;\n    this.changed_names = true;\n    var guests = ($('#quick_guests').val());\n    if (!($.trim(guests) == '')) {\n      if(guests.indexOf(',') === -1) { // Check how the names are delimited (comma or newline)\n        guests = guests.split(\"\\n\")\n      } else {\n        guests = guests.split(\",\")\n      }\n    \n    var collection =  thisProduct.get(\"guests\")\n    var names = _.map(guests, function(name) {\n      name = $.trim(name);\n      return name;\n    })   \n\n    var existing_length = collection.length;\n    var counter = 0;\n    \n    if (names.length == existing_length) {\n    console.log(\"Same\")\n      collection.forEach(function(guest) {    \n       guest.set(\"name\", names[counter])\n        counter = counter + 1;\n      })\n    //\n    } else if (names.length > existing_length) {\n        console.log(\"More--apend\")\n      collection.forEach(function(guest) {    \n        guest.set(\"name\", names[counter])\n       counter = counter + 1;\n      })\n      var new_models = [];\n      for(var i = counter; i < names.length; i++) {\n        new_models.push({ name: names[i] });\n      }\n      collection.add(new_models, {silent:true});\n      collection.trigger(\"addMultiple\", counter)\n    \n    //  \n    } else if (names.length < existing_length) {\n      console.log(\"Less\")\n      for(var i = counter; i < names.length; i++) {\n        var guest = collection.at(i)\n        guest.set({name: names[i]}, {silent:true});\n        counter= counter + 1;\n      }\n      var to_remove = [];\n      for(var i = counter; i < existing_length; i++) {\n        \n       var model = collection.pop({silent:true})\n        model.trigger(\"removeWithoutAffectingTextarea\")\n      }\n      collection.trigger(\"renderNames\", counter)\n    }\n    }\n    this._renderCaret();\n    \n  },500),\n  updateTexture: function(e) {\n    var texture_selected = $(e.currentTarget)\n    this.model.set(\"texture\", texture_selected.index());\n    this.$('.texture').removeClass(\"deselected\");\n    texture_selected.addClass(\"selected\");\n  },\n  // We use the index of the div to toggle it (index is its place within the hierarchy of other siblings obtained by the jquery.index() function), this breaks easily if other divs are added between or before steps. The first sibling\n  // element is actually the img of the name place icon so this counts as index 0, then the first step is index 1. \n  // If we were to move the img then the first step would be index 0 so this would break things. \n  hoverOver: function(e) {\n    var step_index = $(e.currentTarget).index() - 1;\n    this.$('#step_' + step_index + \" .step\").css(\"background-color\", thisProduct.get(\"colours\")[0])      \n    this.$('#step_' + step_index).toggleClass('highlight')\n    if(step_index == 3) {\n        this.$('#print_button').css(\"background-color\", thisProduct.get(\"colours\")[0])\n    }\n  },\n  hoverOut: function(e) {\n    var step_index = $(e.currentTarget).index() - 1;\n    if(step_index != this.current_step) this.$('#step_' + step_index + \" .step\").css(\"background-color\", \"#BBB\") \n     if(step_index == 3) {\n        this.$('#print_button').css(\"background-color\", '#AAA')\n    }\n  },\n  checkout: function() {\n    $('.paypal_spinner').show();\n    $('.buy').hide();\n    thisProduct.makePurchase();\n  },\n  render: function() {    \n    var json_product = thisProduct.toJSON();\n    var guests = thisProduct.get(\"guests\").pluck(\"name\").join(\"\\n\")\n    json_product.guests = guests;\n    var $result = $(Handlebars.template(templates[\"products_show_step_through\"])(json_product));         \n    \n    this.$el.html($result)\n   \n    var colours = thisProduct.get(\"colours\");\n    for(var i=0; i < colours.length; i++) {\n      var $div = $('<div></div>')\n      $result.find('#colour_section_render').append($div)\n      \n      $div.colorPicker({\n        default_color: colours[i], \n        listen_to: thisProduct,\n        index: i\n      });\n    }\n    this.$('#fonts').fontPicker({\n      fonts: casamiento_fonts, \n      selected_font: thisProduct.get(\"font\")\n    });  \n    this.renderWeight();\n    this.renderQtyAndPrice();\n    return this;\n  },  \n  renderQtyAndPrice: function() { \n    this.$('#qty').val(thisProduct.get(\"quantity\"))   \n    this.$('#pound').text(thisProduct.get(\"pounds\"));\n    this.$('#decimal').text(\".\" + thisProduct.get(\"pence\"));  \n  }\n})\n","undoManager":{"mark":99,"position":100,"stack":[[{"start":{"row":115,"column":38},"end":{"row":115,"column":39},"action":"insert","lines":["l"],"id":454}],[{"start":{"row":115,"column":39},"end":{"row":115,"column":40},"action":"insert","lines":["e"],"id":455}],[{"start":{"row":115,"column":40},"end":{"row":115,"column":41},"action":"insert","lines":["n"],"id":456}],[{"start":{"row":115,"column":41},"end":{"row":115,"column":42},"action":"insert","lines":["g"],"id":457}],[{"start":{"row":115,"column":42},"end":{"row":115,"column":43},"action":"insert","lines":["t"],"id":458}],[{"start":{"row":115,"column":43},"end":{"row":115,"column":44},"action":"insert","lines":["h"],"id":459}],[{"start":{"row":115,"column":20},"end":{"row":115,"column":21},"action":"insert","lines":["\""],"id":460}],[{"start":{"row":115,"column":21},"end":{"row":115,"column":22},"action":"insert","lines":["d"],"id":461}],[{"start":{"row":115,"column":22},"end":{"row":115,"column":23},"action":"insert","lines":["e"],"id":462}],[{"start":{"row":115,"column":23},"end":{"row":115,"column":24},"action":"insert","lines":["l"],"id":463}],[{"start":{"row":115,"column":24},"end":{"row":115,"column":25},"action":"insert","lines":["e"],"id":464}],[{"start":{"row":115,"column":25},"end":{"row":115,"column":26},"action":"insert","lines":["t"],"id":465}],[{"start":{"row":115,"column":26},"end":{"row":115,"column":27},"action":"insert","lines":["i"],"id":466}],[{"start":{"row":115,"column":27},"end":{"row":115,"column":28},"action":"insert","lines":["n"],"id":467}],[{"start":{"row":115,"column":28},"end":{"row":115,"column":29},"action":"insert","lines":["g"],"id":468}],[{"start":{"row":115,"column":29},"end":{"row":115,"column":30},"action":"insert","lines":[" "],"id":469}],[{"start":{"row":115,"column":30},"end":{"row":115,"column":31},"action":"insert","lines":["s"],"id":470}],[{"start":{"row":115,"column":31},"end":{"row":115,"column":32},"action":"insert","lines":["t"],"id":471}],[{"start":{"row":115,"column":32},"end":{"row":115,"column":33},"action":"insert","lines":["u"],"id":472}],[{"start":{"row":115,"column":33},"end":{"row":115,"column":34},"action":"insert","lines":["f"],"id":473}],[{"start":{"row":115,"column":34},"end":{"row":115,"column":35},"action":"insert","lines":["f"],"id":474}],[{"start":{"row":115,"column":35},"end":{"row":115,"column":36},"action":"insert","lines":["\""],"id":475}],[{"start":{"row":115,"column":36},"end":{"row":115,"column":37},"action":"insert","lines":[" "],"id":476}],[{"start":{"row":115,"column":36},"end":{"row":115,"column":37},"action":"insert","lines":["m"],"id":477}],[{"start":{"row":115,"column":36},"end":{"row":115,"column":37},"action":"remove","lines":["m"],"id":478}],[{"start":{"row":115,"column":36},"end":{"row":115,"column":37},"action":"insert","lines":[","],"id":479}],[{"start":{"row":114,"column":54},"end":{"row":115,"column":0},"action":"insert","lines":["",""],"id":480},{"start":{"row":115,"column":0},"end":{"row":115,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":115,"column":8},"end":{"row":115,"column":9},"action":"insert","lines":["i"],"id":481}],[{"start":{"row":115,"column":9},"end":{"row":115,"column":10},"action":"insert","lines":["f"],"id":482}],[{"start":{"row":115,"column":10},"end":{"row":115,"column":11},"action":"insert","lines":[" "],"id":483}],[{"start":{"row":115,"column":11},"end":{"row":115,"column":13},"action":"insert","lines":["()"],"id":484}],[{"start":{"row":115,"column":12},"end":{"row":115,"column":13},"action":"insert","lines":["c"],"id":485}],[{"start":{"row":115,"column":13},"end":{"row":115,"column":14},"action":"insert","lines":["o"],"id":486}],[{"start":{"row":115,"column":14},"end":{"row":115,"column":15},"action":"insert","lines":["u"],"id":487}],[{"start":{"row":115,"column":15},"end":{"row":115,"column":16},"action":"insert","lines":["n"],"id":488}],[{"start":{"row":115,"column":16},"end":{"row":115,"column":17},"action":"insert","lines":["t"],"id":489}],[{"start":{"row":115,"column":17},"end":{"row":115,"column":18},"action":"insert","lines":["e"],"id":490}],[{"start":{"row":115,"column":18},"end":{"row":115,"column":19},"action":"insert","lines":["r"],"id":491}],[{"start":{"row":115,"column":19},"end":{"row":115,"column":20},"action":"insert","lines":[" "],"id":492}],[{"start":{"row":115,"column":20},"end":{"row":115,"column":21},"action":"insert","lines":["<"],"id":493}],[{"start":{"row":115,"column":21},"end":{"row":115,"column":22},"action":"insert","lines":[" "],"id":494}],[{"start":{"row":115,"column":22},"end":{"row":115,"column":23},"action":"insert","lines":["1"],"id":495}],[{"start":{"row":115,"column":23},"end":{"row":115,"column":24},"action":"insert","lines":["3"],"id":496}],[{"start":{"row":115,"column":25},"end":{"row":115,"column":26},"action":"insert","lines":[" "],"id":497}],[{"start":{"row":115,"column":26},"end":{"row":115,"column":27},"action":"insert","lines":["{"],"id":498}],[{"start":{"row":115,"column":27},"end":{"row":116,"column":63},"action":"remove","lines":["","        console.log(\"deleting stuff\", counter, existing_length)"],"id":499}],[{"start":{"row":116,"column":7},"end":{"row":116,"column":8},"action":"insert","lines":["v"],"id":511}],[{"start":{"row":116,"column":8},"end":{"row":116,"column":9},"action":"insert","lines":["a"],"id":512}],[{"start":{"row":116,"column":9},"end":{"row":116,"column":10},"action":"insert","lines":["r"],"id":513}],[{"start":{"row":116,"column":10},"end":{"row":116,"column":11},"action":"insert","lines":[" "],"id":514}],[{"start":{"row":116,"column":11},"end":{"row":116,"column":12},"action":"insert","lines":["m"],"id":515}],[{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"insert","lines":["o"],"id":516}],[{"start":{"row":116,"column":13},"end":{"row":116,"column":14},"action":"insert","lines":["d"],"id":517}],[{"start":{"row":116,"column":14},"end":{"row":116,"column":15},"action":"insert","lines":["e"],"id":518}],[{"start":{"row":116,"column":15},"end":{"row":116,"column":16},"action":"insert","lines":["l"],"id":519}],[{"start":{"row":116,"column":16},"end":{"row":116,"column":17},"action":"insert","lines":[" "],"id":520}],[{"start":{"row":116,"column":17},"end":{"row":116,"column":18},"action":"insert","lines":["="],"id":521}],[{"start":{"row":116,"column":48},"end":{"row":117,"column":0},"action":"insert","lines":["",""],"id":522},{"start":{"row":117,"column":0},"end":{"row":117,"column":7},"action":"insert","lines":["       "]}],[{"start":{"row":117,"column":7},"end":{"row":117,"column":8},"action":"insert","lines":["m"],"id":523}],[{"start":{"row":117,"column":8},"end":{"row":117,"column":9},"action":"insert","lines":["o"],"id":524}],[{"start":{"row":117,"column":9},"end":{"row":117,"column":10},"action":"insert","lines":["d"],"id":525}],[{"start":{"row":117,"column":10},"end":{"row":117,"column":11},"action":"insert","lines":["e"],"id":526}],[{"start":{"row":117,"column":11},"end":{"row":117,"column":12},"action":"insert","lines":["l"],"id":527}],[{"start":{"row":117,"column":12},"end":{"row":117,"column":13},"action":"insert","lines":["."],"id":528}],[{"start":{"row":117,"column":13},"end":{"row":117,"column":14},"action":"insert","lines":["t"],"id":529}],[{"start":{"row":117,"column":14},"end":{"row":117,"column":15},"action":"insert","lines":["r"],"id":530}],[{"start":{"row":117,"column":15},"end":{"row":117,"column":16},"action":"insert","lines":["i"],"id":531}],[{"start":{"row":117,"column":16},"end":{"row":117,"column":17},"action":"insert","lines":["g"],"id":532}],[{"start":{"row":117,"column":17},"end":{"row":117,"column":18},"action":"insert","lines":["g"],"id":533}],[{"start":{"row":117,"column":18},"end":{"row":117,"column":19},"action":"insert","lines":["e"],"id":534}],[{"start":{"row":117,"column":19},"end":{"row":117,"column":20},"action":"insert","lines":["r"],"id":535}],[{"start":{"row":117,"column":20},"end":{"row":117,"column":22},"action":"insert","lines":["()"],"id":536}],[{"start":{"row":117,"column":21},"end":{"row":117,"column":23},"action":"insert","lines":["\"\""],"id":537}],[{"start":{"row":117,"column":22},"end":{"row":117,"column":23},"action":"insert","lines":["r"],"id":538}],[{"start":{"row":117,"column":23},"end":{"row":117,"column":24},"action":"insert","lines":["e"],"id":539}],[{"start":{"row":117,"column":24},"end":{"row":117,"column":25},"action":"insert","lines":["m"],"id":540}],[{"start":{"row":117,"column":25},"end":{"row":117,"column":26},"action":"insert","lines":["o"],"id":541}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":27},"action":"insert","lines":["v"],"id":542}],[{"start":{"row":117,"column":27},"end":{"row":117,"column":28},"action":"insert","lines":["e"],"id":543}],[{"start":{"row":117,"column":28},"end":{"row":117,"column":29},"action":"insert","lines":["A"],"id":544}],[{"start":{"row":117,"column":28},"end":{"row":117,"column":29},"action":"remove","lines":["A"],"id":545}],[{"start":{"row":117,"column":28},"end":{"row":117,"column":29},"action":"insert","lines":["W"],"id":546}],[{"start":{"row":117,"column":29},"end":{"row":117,"column":30},"action":"insert","lines":["i"],"id":547}],[{"start":{"row":117,"column":30},"end":{"row":117,"column":31},"action":"insert","lines":["t"],"id":548}],[{"start":{"row":117,"column":31},"end":{"row":117,"column":32},"action":"insert","lines":["h"],"id":549}],[{"start":{"row":117,"column":32},"end":{"row":117,"column":33},"action":"insert","lines":["o"],"id":550}],[{"start":{"row":117,"column":33},"end":{"row":117,"column":34},"action":"insert","lines":["u"],"id":551}],[{"start":{"row":117,"column":34},"end":{"row":117,"column":35},"action":"insert","lines":["t"],"id":552}],[{"start":{"row":117,"column":22},"end":{"row":117,"column":35},"action":"remove","lines":["removeWithout"],"id":553},{"start":{"row":117,"column":22},"end":{"row":117,"column":52},"action":"insert","lines":["removeWithoutAffectingTextarea"]}],[{"start":{"row":115,"column":27},"end":{"row":116,"column":48},"action":"remove","lines":["","       var model = collection.pop({silent:true})"],"id":554}],[{"start":{"row":114,"column":54},"end":{"row":115,"column":0},"action":"insert","lines":["",""],"id":555},{"start":{"row":115,"column":0},"end":{"row":115,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":115,"column":8},"end":{"row":116,"column":48},"action":"insert","lines":["","       var model = collection.pop({silent:true})"],"id":556}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":27},"action":"remove","lines":["{"],"id":557}],[{"start":{"row":117,"column":26},"end":{"row":118,"column":0},"action":"remove","lines":["",""],"id":558}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":28},"action":"remove","lines":["  "],"id":559}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":28},"action":"remove","lines":["  "],"id":560}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":28},"action":"remove","lines":["  "],"id":561}],[{"start":{"row":117,"column":26},"end":{"row":117,"column":27},"action":"remove","lines":[" "],"id":562}],[{"start":{"row":117,"column":8},"end":{"row":117,"column":25},"action":"remove","lines":["if (counter < 13)"],"id":563}],[{"start":{"row":117,"column":8},"end":{"row":117,"column":9},"action":"remove","lines":[" "],"id":564}],[{"start":{"row":80,"column":0},"end":{"row":81,"column":35},"action":"remove","lines":["","    //thisProduct.trigger('redraw')"],"id":565}]]},"ace":{"folds":[],"scrolltop":1190,"scrollleft":0,"selection":{"start":{"row":102,"column":48},"end":{"row":102,"column":48},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":97,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1439764485000}