{"ts":1351770217515,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var querystring = require('querystring'),\n    Args = require('vargs').Constructor,\n    cradle = require('../../cradle'),\n    Database = require('./index').Database;\n\nDatabase.prototype.getAttachment = function (id, attachmentName, callback) {\n    //\n    // TODO: Update cache?\n    //\n    \n    return this.connection.rawRequest({\n        method: 'GET', \n        path: '/' + [this.name, querystring.escape(id), attachmentName].join('/')\n    }, callback);\n};\n\nDatabase.prototype.removeAttachment = function (doc, attachmentName, callback) {\n    var params,\n        rev,\n        id;\n\n    if (typeof doc === 'string') {\n        id = doc;\n    } else {\n        id  = doc.id  || doc._id;\n        rev = doc.rev || doc._rev;\n    }\n    \n    if (!id) {\n        error = new(TypeError)(\"first argument must be a document id\");\n        if (!callback) { throw error }\n        return callback(error);\n    }\n    \n    if (!rev && this.cache.has(id)) {\n        rev = this.cache.get(id)._rev;\n    } else if (rev) {\n        rev = rev.replace(/\\\"/g, '');\n    }\n\n    this.query({\n        method: 'DELETE',\n        path: [querystring.escape(id), attachmentName].join('/'),\n        query: { rev: rev }\n    }, callback);\n};\n\nDatabase.prototype.saveAttachment = function (doc, attachment, callback) {\n    var attachmentName,\n        options = {},\n        self = this,\n        params,\n        error,\n        rev,\n        id;\n    \n    if (typeof doc === 'string') {\n        id = doc;\n    } else {\n        id  = doc.id  || doc._id;\n        rev = doc.rev || doc._rev;\n    }\n\n    if (!id) {\n        error = new(TypeError)(\"Missing document id.\");\n        if (!callback) { throw error }\n        return callback(error);\n    }\n    \n    attachmentName = typeof attachment !== 'string'\n        ? attachment.name\n        : attachment;\n    \n    if (!rev && this.cache.has(id)) {\n        params = { rev: this.cache.get(id)._rev };\n    } else if (rev) {\n        params = { rev: rev.replace(/\\\"/g, '') };\n    }\n    \n    options.method = 'PUT';\n    options.path = '/' + [this.name, querystring.escape(id), attachmentName].join('/');\n    options.headers = {\n        'Content-Type': attachment['content-type'] \n            || attachment['contentType']\n            || attachment['Content-Type'] \n            || 'text/plain'\n    };\n    \n    if (attachment.body) {\n        options.body = attachment.body;\n    }\n    \n    if (params) {\n        options.path += ('?' + querystring.stringify(params));\n    }\n    \n    return this.connection.rawRequest(options, function (err, res, body) {\n        var result = JSON.parse(body);\n        result.headers = res.headers;\n        result.headers.status = res.statusCode;\n\n        if (result.headers.status == 201) {\n            if (self.cache.has(id)) {\n                cached = self.cache.store[id].document;\n                cached._rev = result.rev;\n                cached._attachments = cached._attachments || {};\n                cached._attachments[attachmentName] = { stub: true };\n            }\n            \n            return callback(null, result);\n        }\n        \n        callback(result);\n    });\n};\n\n//\n// Alias `saveAttachment` to `addAttachment`\n//\nDatabase.prototype.addAttachment = Database.prototype.saveAttachment;\n"]],"start1":0,"start2":0,"length1":0,"length2":3223}]],"length":3223}
{"contributors":[],"silentsave":false,"ts":1351770716700,"patch":[[{"diffs":[[0,"    id;\n    "],[1,"console.log(attachment);"],[0,"\n    if (typ"]],"start1":1388,"start2":1388,"length1":24,"length2":48}]],"length":3247,"saved":false}
{"ts":1351770746324,"patch":[[{"diffs":[[0,"id;\n"],[-1,"    console.log(attachment);\n"],[0,"    "]],"start1":1392,"start2":1392,"length1":37,"length2":8}]],"length":3218,"saved":false}
{"ts":1351770879059,"patch":[[{"diffs":[[0,"        id;\n"],[1,"        console.log(attachment);\n"],[0,"    if (type"]],"start1":1384,"start2":1384,"length1":24,"length2":57}]],"length":3251,"saved":false}
