{"ts":1349374311395,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var xml2js = require('xml2js'),\r\n    api = require('./../config/ebay_config')(),\r\n    xmlParser = new xml2js.Parser({trim: false, normalize: false}), // Important whitespace settings to preserve newlines in XML-parsed messages\r\n    db = require('./../config/database').db;\r\n    \r\nmodule.exports = readMessage;\r\n\r\nfunction readMessage(xml, cb) {\r\n    xmlParser.parseString(xml, function(err, json_data) {\r\n        parseMessage(json_data, function(err, message) {\r\n            if (err) {\r\n                cb(err);\r\n            }\r\n            else {\r\n                findCustomer(message, function(e, r) {\r\n                    cb(e, r);\r\n                });\r\n            }\r\n        })\r\n    })\r\n}\r\n\r\n// Find a customer in the database by searching for the EIASToken of the message\r\nfunction findCustomer(message, cb) {\r\n    db.get(message.EIASToken, function(err, res) {\r\n        if (err && err.error == 'not_found' && err.reason == 'missing') {\r\n            message.customer = message.EIASToken;\r\n            createCustomer(message, cb);\r\n        }\r\n        else if (!err) {\r\n            console.log(\"FOUND CUSTOMER!\", res.UserIDs);\r\n            message.customer = res._id;\r\n            db.save(message, function(e, r) {\r\n                cb(e, r);\r\n            })\r\n        }\r\n        else {\r\n            cb(err, res);\r\n        }\r\n    })\r\n}\r\n\r\nfunction createCustomer(message, cb) {\r\n    db.save([message,\r\n    {\r\n        _id: message.EIASToken,\r\n        type: \"Customer\",\r\n        UserIDs: [message.Sender]\r\n    }], function(err, res) {\r\n        var customer_record = res[1];\r\n        if (customer_record.error == 'conflict') {\r\n            findCustomer(message, cb);\r\n        }\r\n        else {\r\n            cb(err, res);\r\n        }\r\n    });\r\n}\r\n\r\nfunction parseMessage(message, cb) {\r\n    if (message[\"soapenv:Body\"]) { // Pass message from ebay NOTIFY or from an xml file\r\n    var m = message[\"soapenv:Body\"].GetMyMessagesResponse.Messages.Message;\r\n    } else {\r\n        var m = message.Messages.Message;\r\n    }\r\n    m.type = \"ebay_message\";\r\n    m._id = m.Sender + '-' + m.MessageID;\r\n    delete m.SendingUserID;\r\n    delete m.RecipientUserID;\r\n    delete m.SendToName;\r\n    delete m.Flagged;\r\n    delete m.Read;\r\n    delete m.Folder;\r\n    delete m.Replied;\r\n    if (!m.Content) {\r\n        m.Text = m.Text.replace('<![CDATA[', '');\r\n        m.Text = m.Text.replace(/]]>$/, '');\r\n        m.Text = m.Text.replace(/<(?:.|\\n)*?>/gm, '');\r\n        m.Content = m.Text;\r\n    }\r\n    delete m.Text;\r\n    getEiasTokenForUser(m.Sender, function(err, res) {\r\n        m.EIASToken = res;\r\n        cb(err, m);\r\n    })\r\n}\r\n\r\nfunction getEiasTokenForUser(userId, cb) {\r\n    api.makeRequest(\"GetUser\", function(err, res) {\r\n\r\n        if (res && res.User && res.User.EIASToken) {\r\n            var user = res.User.EIASToken;\r\n        }\r\n        else {\r\n            err = err || {\r\n                reason: \"Could not get EIASToken\"\r\n            }\r\n        }\r\n        cb(err, user);\r\n    }, {\r\n        UserID: userId\r\n    }, \"json\")\r\n}"]],"start1":0,"start2":0,"length1":0,"length2":3014}]],"length":3014}
