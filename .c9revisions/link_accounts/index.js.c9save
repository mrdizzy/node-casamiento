{"ts":1351174233288,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var migrator = require('couchdb-migrator'),\n    db = migrator.db,\n    _ = require('underscore');\n\nvar new_email = \"happyhele@hotmail.com\"\n\n// Scenario:\n//  - An incoming eBay order is received\n//  - The email address of the order matches a customer in the database\n//  - The EIAS token of the order is already assigned to a different customer in the database\n//  - We need to:\n\nfunction consolidateCustomers(EIAS, email, callback) {\n    db.view('customers/by_id_and_email', {\n        key: [EIAS, email]\n    }, function(err, res) {\n        if (err || res.length > 0) {\n            callback(err, res);\n        }\n        else {\n            find_customer_by_email(EIAS, email, callback);\n        }\n    });\n}\n\nfunction find_customer_by_email(EIAS, email, callback) {\n    db.get(EIAS, function(error, originalCustomer) {\n        if (error) {\n            createCustomer(EIAS, email, callback);\n        }\n        else {\n            db.view(\"customers/by_email\", {\n                key: email\n            }, function(err, customersByEmail) {\n                if(customersByEmail.length > 0) {\n                    consolidation(originalCustomer, customersByEmail, callback)\n                }\n                else {\n                        addEmailToExistingCustomer();\n                    }\n            })\n        }\n    })\n}\n\n\nfunction consolidation(originalCustomer, customersByEmail, callback) {\n    console.log(\"Consolidation, linking accounts\");   \n}\nfunction createCustomer(originalCustomer, callback) {\n    console.log(\"Creating new customer\");\n}\n\nfunction addEmailToExistingCustomer() {\n console.log(\"Adding email to existing customer\");   \n}\nconsolidateCustomers(\"EIASTOKENFORY\", \"rebelcoo7@hotmail.com\", function(e, r) {\n    console.log(\"error\", e, r)\n\n});\n\n\n/*twoCustomers(\"EIASTOKENFORGARY\", \"rebelcoo7@hotmail.com\", function(e, original, r) {\n    if(r) {\n            var doc = r.toArray()[0],\n              consolidateEmails = _.union(original.emails, doc.emails)\n            db.merge(original._id,{ emails: consolidateEmails},function(a, b) {\n                db.remove(doc._id, doc._rev, function(c,d) {\n                    console.log(c,d);\n                    })\n            \n            \n        })\n    console.log(e,r);\n    }\n});*/"]],"start1":0,"start2":0,"length1":0,"length2":2236}]],"length":2236}
