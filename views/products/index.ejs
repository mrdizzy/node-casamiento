<html>
<head>

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.0/jquery-1.8.0.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
<script type="text/javascript">
$(function() {
    Backbone.Model.CouchDB = Backbone.Model.extend({
        host: "casamiento.iriscouch.com",
        database: "test_ebay",
        idAttribute: "_id",
        attachments: function() {
            if (this._attachments) {
                return this._attachments
            }
            else {
                this._attachments = _.map(Object.keys(this.get("_attachments")), function(a) {
                    var attachment = {
                        _id: a,
                        url: this.collection.url + "/" + this.id + "/attachments/" + a,
                        couch_url: this.host + "/" + this.database + "/" + this.id + "/" + a,
                        destroy: function() {
                            $.ajax({type: "DELETE", url: this.url});   
                        }
                    }
                    return attachment;
                }, this)
                return this._attachments
            }
        }
    });
    
    var Product = Backbone.Model.CouchDB.extend({});
    var Products = Backbone.Collection.extend({
        model: Product,
        url: '/products'
    });
    var products = new Products( <%- JSON.stringify(products) %> );
    var AttachmentView = Backbone.View.extend({
        events: {
            'click .destroy': 'destroy'
        },
        destroy: function() {
            this.model.destroy();
        },
        render: function() {
            this.$el.html("<li><a href=\"http://" + this.model.couch_url + "\">" + this.model._id + " </a> <a class=\"destroy\">destroy</a>")
            return this;
        }
    });
    
    var CurrentProductView = Backbone.View.extend({
        el: '#current_product',
        render: function() {
            
            var attachments = [];
            console.log(this.model.attachments());
            this.model.attachments().forEach(function(a) {
                attachments.push(new AttachmentView({model: a}).render().el);
                }, this);
                
                this.$el.html(attachments);
            return this;
        }
    })

    var cpv = new CurrentProductView({
        model: products.at(0)
    });
    var ProductView = Backbone.View.extend({
                events: { 'click': 'select' },
        select: function() {
              cpv.model = this.model;
              cpv.render();
        },
        render: function() {
            this.$el.html(this.model.id);
            return this;
        }
    });
    var ProductsView = Backbone.View.extend({
        el: '#products',
        render: function() {
            this.$el.empty();
            this.collection.forEach(function(product) {
                var productview = new ProductView({
                    model: product
                }).render().el
            this.$el.append(productview);
            }, this) 
            return this;
        }
    });
    cpv.render();

    new ProductsView({
        collection: products
    }).render();
})


</script>
</head>
<body>

<div id="products">

</div>
<h2>Current Product:</h2>
<div id="current_product">

</div>
</body>
</html>