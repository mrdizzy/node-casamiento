<html>
    <head>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.0/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0.beta6/handlebars.min.js"></script>
    <script src="/javascripts/couchdb_attachments.js"></script>
    
    <script type="text/template" id="attachment_view">
        <img src="{{path "thumb"}}"/><a class="destroy">Destroy</a>
            <form method="POST" action="{{url}}" enctype="multipart/form-data" target="iframe_{{id}}">
            <input type="hidden" name="rev" value="{{get "_rev"}}"></input>
            {{get "_rev"}}
            <input type="file" name="thumb-{{id}}"></input><br/>
            <input type="file" name="medium-{{id}}"></input><br/>
            <input type="file" name="display-{{id}}"></input><br/>
            <input type="file" name="large-{{id}}"></input><br/>
            <input type="hidden" name="_method" value="put" />
            <input type="submit"></input>
            </form>
    </script>
    
    <script type="text/template" id="current_product_form">
        <form id="edit_product">
            <h1>{{ _id }}</h1>        
            <p><label for="price">Price:</label> <input type="text" name="price" value="{{price}}"></input></p>
            <input type="submit" id="submitter">Submit</a>
        </form>
    </script>
    
<script type="text/javascript">

$(function() {    
    // MODELS
    var Product = Backbone.Model.CouchDB.extend({});
    var Products = Backbone.Collection.extend({
        model: Product,
        url: "/products"
    });

    var ProductView = Backbone.View.extend({
        events: {
            'click': 'select'
        },
        select: function() {
            current_product_collection.reset(this.model);
        },
        render: function() {
            this.$el.html(this.model.id);
            return this;
        }
    });
    
    // VIEWS
    var ProductsView = Backbone.View.extend({
        el: '#products',
        render: function() {
            this.$el.empty();
            this.collection.forEach(function(product) {
                var productview = new ProductView({
                    model: product
                }).render().el
            this.$el.append(productview);
            }, this) 
            return this;
        }
    });
    
    var CurrentProductView = Backbone.View.extend({
        el: '#current_product',
        initialize: function() {
            this.collection.bind('reset', this.render, this);            
            //this.collection.at(0).bind('change', this.render, this);
        },
        events: { 
            'click #submitter': 'sendForm'
        },
        sendForm: function(e) {
            e.preventDefault();
            this.collection.at(0).set({ price: this.$('input[name="price"]').val(), colours: this.$('input[name="colours"]').val()});
            this.collection.at(0).save({}, { success: function(a, b, c) {
                console.log(a,b,c)
            }});
        },
        render: function() {
            console.log("Rendering current view");
            var that = this;
            var result = Handlebars.compile($('#current_product_form').html())(this.collection.at(0).toJSON());
            this.$el.html(result);
            this.$el.append(new AttachmentsView({collection: this.collection.at(0).attachments}).render().el);
                    
            return this;
        }
    })
    var AttachmentsView = Backbone.View.Attachment.extend({
        render: function() {

                var that = this;
            var attachments = this.collection.map(function(attachment) {
                return new AttachmentView({
                    model: attachment
                }).render().el;
            });
            this.$('#sortable').html(attachments);
            this.collection.forEach(function(attachment) {
                var iframe = $("<iframe name=\"iframe_" + attachment.id + "\"><html><body>Horrah</body></html></iframe>");
                this.$el.append(iframe);
                var counter = 0;
                iframe.load(function() {
                    if (counter > 0) {
                        console.log("Fetching");
                        that.collection.belongs_to.fetch();
                    }
                    counter++;
                })
            }, this);
        return this;
    }
    });
    var AttachmentView = Backbone.View.extend({
        initialize: function() {
             this.counter = 0;
             this.model.bind('change', this.render, this);
        },
        events: { 
            'click .destroy' : 'remove'  
        },
        remove: function(a,b) {
            var that = this;
          this.model.destroy({data: "_rev=" + that.model.get("_rev") }); 
        },
        render: function() {
            var that= this;
            var result = Handlebars.compile($('#attachment_view').html())(this.model);
            
            console.log("Rendering AAA VIEW");
            this.el.id = this.model.id;
            this.$el.html(result);
            //this.$('iframe').load(function() {
            //    if (that.counter > 0) {
            //        console.log("Fetching");
            //        //that.model.collection.belongs_to.fetch();
            //    }                
            //    that.counter++;
            //});
            return this;
        }
    })
    
    var CurrentProductCollection = Backbone.Collection.extend({});
    
    var product_types = <%- JSON.stringify(product_types) %>;
    var themes = <%- JSON.stringify(themes) %>;
    var products = new Products( <%- JSON.stringify(products) %>, {parse: true} );
    
    var current_product_collection = new CurrentProductCollection(products.at(0));
    var cpv = new CurrentProductView({
        collection: current_product_collection
    });

    cpv.render();

    new ProductsView({
        collection: products
    }).render();
    
})

</script>
</head>
<body>

<div id="products"></div>

<h2>Current Product:</h2>
<div id="current_product"></div>

</body>
</html>